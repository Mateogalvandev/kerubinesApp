<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Venta - Kerubines App</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="stylesheet" th:href="@{/css/venta.css}">
</head>
<body>
<!-- Header -->
<header class="header">
    <div class="header-left">
        <button class="menu-toggle" id="menuToggle">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <h1 class="logo"><a href="/">Kerubines App</a></h1>
    </div>
    <div class="header-right">
        <div class="user-menu">
            <button class="user-button" id="userButton">
                <svg class="user-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
                <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6,9 12,15 18,9"></polyline>
                </svg>
            </button>
            <div class="dropdown-menu" id="dropdownMenu">
                <form th:action="@{/logout}" method="post" style="margin: 0; padding: 0;">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <button type="submit" class="dropdown-item logout">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16,17 21,12 16,7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        Cerrar Sesión
                    </button>
                </form>
            </div>
        </div>
    </div>
</header>
<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
    <nav class="sidebar-nav">
        <!-- Venta Section -->
        <div class="nav-section">
            <button class="nav-item nav-toggle active" data-target="ventaSubmenu">
                <div class="nav-item-content">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3h18v18H3zM9 9h6v6H9z"></path>
                    </svg>
                    <span>Venta</span>
                </div>
                <svg class="nav-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                     style="transform: rotate(90deg);">
                    <polyline points="9,18 15,12 9,6"></polyline>
                </svg>
            </button>
            <div class="nav-submenu active" id="ventaSubmenu">
                <a href="#" class="nav-subitem" th:href="@{/venta/crear}">
                    <svg class="nav-subicon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Crear
                </a>
                <a href="#" class="nav-subitem active" th:href="@{/venta/administrar}">
                    <svg class="nav-subicon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z">
                        </path>
                    </svg>
                    Administrar
                </a>
            </div>
        </div>
        <!-- Usuarios Section -->
        <div class="nav-section">
            <button class="nav-item nav-toggle" data-target="usuariosSubmenu">
                <div class="nav-item-content">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span>Usuarios</span>
                </div>
                <svg class="nav-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9,18 15,12 9,6"></polyline>
                </svg>
            </button>
            <div class="nav-submenu" id="usuariosSubmenu">
                <a href="#" class="nav-subitem" th:href="@{/usuarios/crear}">
                    <svg class="nav-subicon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Crear
                </a>
                <a href="#" class="nav-subitem" th:href="@{/usuarios/administrar}">
                    <svg class="nav-subicon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z">
                        </path>
                    </svg>
                    Administrar
                </a>
            </div>
        </div>
        <!-- Productos Section -->
        <div class="nav-section">
            <button class="nav-item nav-toggle" data-target="productosSubmenu">
                <div class="nav-item-content">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <path d="M16 10a4 4 0 0 1-8 0"></path>
                    </svg>
                    <span>Productos</span>
                </div>
                <svg class="nav-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9,18 15,12 9,6"></polyline>
                </svg>
            </button>
            <div class="nav-submenu" id="productosSubmenu">
                <a href="#" class="nav-subitem" th:href="@{/productos/crear}">
                    <svg class="nav-subicon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Crear
                </a>
                <a href="#" class="nav-subitem" th:href="@{/productos/administrar}">
                    <svg class="nav-subicon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z">
                        </path>
                    </svg>
                    Administrar
                </a>
            </div>
        </div>
    </nav>
</aside>
<!-- Main Content -->
<main class="main-content" id="mainContent">
    <div class="container-fluid">
        <!-- Título de la página -->
        <div class="page-header">
            <h2 class="page-title">Editar Venta</h2>
            <p class="page-subtitle">Modifica los detalles de la venta existente.</p>
        </div>
        <br>
        <!-- Formulario de Venta -->
        <form class="sales-form" id="salesForm" th:action="@{/venta/editar/post/{id}(id=${ventaEditar.idVenta})}" th:object="${ventaEditar}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <input type="hidden" th:field="*{idVenta}" />
            <input type="hidden" th:field="*{date}" /> <!-- Mantener la fecha original o actualizarla en el backend -->
            <input type="hidden" th:field="*{total}" id="totalHidden"> <!-- Campo oculto para el total -->
            <div th:if="${error}" class="alert alert-danger" role="alert">
                <p th:text="${error}"></p>
            </div>
            <div class="form-grid">
                <!-- Información del Cliente -->
                <div class="form-section">
                    <div class="section-header">
                        <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        <h3>Información del Cliente</h3>
                    </div>
                    <div class="form-group">
                        <label for="nombreCliente">Nombre del Cliente *</label>
                        <input type="text" id="nombreCliente" th:field="*{nombreCliente}" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="numeroCliente">Teléfono</label>
                        <input type="tel" id="numeroCliente" th:field="*{numeroCliente}" class="form-input">
                    </div>
                </div>
                <!-- Responsable de la Venta -->
                <div class="form-section">
                    <div class="section-header">
                        <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        <h3>Responsable de la Venta</h3>
                    </div>
                    <div class="form-group">
                        <label for="responsableVenta">Vendedor</label>
                        <input type="text" id="responsableVenta" name="responsableVenta" class="form-input"
                               th:value="${ventaEditar.usuarioVenta != null ? ventaEditar.usuarioVenta.nombre : 'N/A'}" readonly>
                        <input type="hidden" name="idResponsable" th:value="${ventaEditar.usuarioVenta != null ? ventaEditar.usuarioVenta.idUsuario : ''}">
                    </div>
                </div>
            </div>
            <!-- Selección de Productos -->
            <div class="form-section">
                <div class="section-header">
                    <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <path d="M16 10a4 4 0 0 1-8 0"></path>
                    </svg>
                    <h3>Selección de Productos</h3>
                </div>
                <!-- Botón para abrir el selector de productos -->
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button type="button" class="btn btn-secondary" id="openProductSearchBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 17.25a6.25 6.25 0 1 1 0-12.5 6.25 6.25 0 0 1 0 12.5ZM17.25 17.25l4.75 4.75"></path>
                        </svg>
                        Buscar y Agregar Producto
                    </button>
                </div>
                <!-- Tabla de productos agregados -->
                <div class="form-group">
                    <div class="table-container">
                        <table class="product-table" id="productosAgregados">
                            <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Precio Unitario</th>
                                <th>Total</th>
                                <th>Acciones</th>
                            </tr>
                            </thead>
                            <tbody>
                            <!-- Se llenará dinámicamente con JavaScript -->
                            </tbody>
                        </table>
                        <div class="empty-products" id="emptyProducts" style="display: block;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                                <line x1="3" y1="6" x2="21" y2="6"></line>
                                <path d="M16 10a4 4 0 0 1-8 0"></path>
                            </svg>
                            <p>No hay productos agregados</p>
                            <span>Usa el botón "Buscar y Agregar Producto" para añadir ítems a la venta.</span>
                        </div>
                    </div>
                </div>
                <!-- Inputs ocultos para enviar productos al backend -->
                <div id="productosHiddenContainer"></div>
            </div>
            <!-- Método de Pago, Modalidad de Venta y Configuración -->
            <div class="form-grid">
                <div class="form-section">
                    <div class="section-header">
                        <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                            <line x1="1" y1="10" x2="23" y2="10"></line>
                        </svg>
                        <h3>Método de Pago</h3>
                    </div>
                    <div class="payment-methods">
                        <label class="payment-option">
                            <input type="radio" th:field="*{tipoDeVenta}" value="EFECTIVO" class="form-radio">
                            <span class="payment-label">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="1" x2="12" y2="23"></line>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                  </svg>
                  Efectivo
                </span>
                        </label>
                        <label class="payment-option">
                            <input type="radio" th:field="*{tipoDeVenta}" value="TRANSFERENCIA" class="form-radio">
                            <span class="payment-label">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7,10 12,15 17,10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                  </svg>
                  Transferencia
                </span>
                        </label>
                        <label class="payment-option">
                            <input type="radio" th:field="*{tipoDeVenta}" value="TARJETA" class="form-radio">
                            <span class="payment-label">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                    <line x1="1" y1="10" x2="23" y2="10"></line>
                  </svg>
                  Tarjeta
                </span>
                        </label>
                    </div>
                </div>
                <div class="form-section">
                    <div class="section-header">
                        <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 16V8a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2z"></path>
                            <path d="M16 12h2"></path>
                            <path d="M6 12h2"></path>
                            <path d="M10 12h4"></path>
                        </svg>
                        <h3>Modalidad de Venta</h3>
                    </div>
                    <div class="payment-methods">
                        <label class="payment-option">
                            <input type="radio" th:field="*{modalidadVenta}" value="PRESENCIAL" class="form-radio">
                            <span class="payment-label">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9,22 9,12 15,12 15,22"></polyline>
                  </svg>
                  Presencial
                </span>
                        </label>
                        <label class="payment-option">
                            <input type="radio" th:field="*{modalidadVenta}" value="ONLINE" class="form-radio">
                            <span class="payment-label">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="2" y1="12" x2="22" y2="12"></line>
                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                  </svg>
                  Online
                </span>
                        </label>
                    </div>
                </div>
                <div class="form-section">
                    <div class="section-header">
                        <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M8 12l2 2 4-4"></path>
                        </svg>
                        <h3>Porcentaje</h3>
                    </div>
                    <div class="form-group">
                        <div class="percentage-input-container">
                            <input type="number" id="porcentajeInput" placeholder="0" th:field="*{porcentaje}" class="form-input" min="-100" max="1000" step="0.1">
                            <span class="percentage-symbol">%</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Resumen de la Venta -->
            <div class="form-section summary-section">
                <div class="section-header">
                    <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 11H5a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h4m6-6h4a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-4m-6 0a2 2 0 0 0-2-2v-3a2 2 0 0 0 2-2m6 0a2 2 0 0 1 2-2v-3a2 2 0 0 1-2-2">
                        </path>
                    </svg>
                    <h3>Resumen de la Venta</h3>
                </div>
                <div class="summary-content">
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span class="summary-value" id="subtotalAmount">$0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>Porcentaje Adicional:</span>
                        <span class="summary-value" id="percentageAmount">0% ($0.00)</span>
                    </div>
                    <div class="summary-row total-row">
                        <span>Total:</span>
                        <span class="summary-value" id="totalAmount">$0.00</span>
                    </div>
                </div>
            </div>
            <!-- Botones de Acción -->
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="window.history.back()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    Cancelar
                </button>
                <button type="submit" class="btn btn-primary">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Guardar Cambios
                </button>
            </div>
        </form>
    </div>
</main>
<!-- Overlay for mobile -->
<div class="overlay" id="overlay"></div>
<!-- Modal para seleccionar productos -->
<div class="modal" id="productModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Seleccionar Producto</h3>
            <button type="button" class="modal-close" id="closeModal">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="product-search">
                <input type="text" id="productSearch" placeholder="Buscar por nombre, color, talla..." class="form-input">
            </div>
            <div class="products-list-table-container">
                <table class="product-search-table">
                    <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Talla</th>
                        <th>Color</th>
                        <th>Costo</th>
                        <th>Stock</th>
                        <th>Acción</th>
                    </tr>
                    </thead>
                    <tbody id="productSearchResultsBody">
                    <!-- Los productos se cargarán aquí desde JavaScript -->
                    </tbody>
                </table>
                <div class="empty-search-results" id="emptySearchResults" style="display: none;">
                    <p>No se encontraron productos que coincidan con la búsqueda.</p>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Script para cargar los productos desde Thymeleaf a JavaScript -->
<script th:inline="javascript">
    /*<![CDATA[*/
    // Array con todos los productos disponibles
    var allProducts = [];
    /*[# th:each="producto : ${productosDisponibles}"]*/
    allProducts.push({
      idProducto: /*[[${producto.idProducto}]]*/ null,
      nombreProducto: /*[[${producto.nombreProducto}]]*/ '',
      talla: /*[[${producto.talla}]]*/ '',
      color: /*[[${producto.color}]]*/ '',
      descripcion: /*[[${producto.descripcion}]]*/ '',
      costo: /*[[${producto.costo}]]*/ 0.0,
      stock: /*[[${producto.stock}]]*/ 0
    });
    /*[/]*/
    console.log("Productos cargados desde Thymeleaf (allProducts):", allProducts);

    // Inicializar productosAgregados con los items existentes de la venta
    let productosAgregados = [];
    const existingItems = /*[[${ventaEditar.items}]]*/ [];
    console.log("Items de venta existentes (existingItems) directamente desde Thymeleaf:", existingItems);

    existingItems.forEach(itemDto => {
        console.log("Procesando itemDto:", itemDto);
        console.log("ID de producto en itemDto:", itemDto.productoId);
        console.log("Cantidad en itemDto:", itemDto.cantidad);
        console.log("Precio Unitario en itemDto:", itemDto.precioUnitario);

        const product = allProducts.find(p => p.idProducto == itemDto.productoId);
        if (product) {
            console.log("Producto encontrado en allProducts:", product);
            productosAgregados.push({
                productoId: itemDto.productoId,
                nombre: product.nombreProducto,
                precio: itemDto.precioUnitario, // Usa el precio unitario guardado en ItemVentaDto
                cantidad: itemDto.cantidad,
                stock: product.stock // Usa el stock actual del producto para validaciones
            });
        } else {
            console.log("Producto NO encontrado en allProducts para id:", itemDto.productoId);
        }
    });
    console.log("Items de venta existentes cargados en productosAgregados:", productosAgregados);

    // ... (rest of the script) ...
</script>
<script>
    // --- Funcionalidades generales de la UI ---
    // Toggle sidebar
    const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    menuToggle.addEventListener('click', () => {
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
      document.body.classList.toggle('sidebar-open');
    });
    overlay.addEventListener('click', () => {
      sidebar.classList.remove('active');
      overlay.classList.remove('active');
      document.body.classList.remove('sidebar-open');
    });
    // Toggle user dropdown
    const userButton = document.getElementById('userButton');
    const dropdownMenu = document.getElementById('dropdownMenu');
    userButton.addEventListener('click', (e) => {
      e.stopPropagation();
      dropdownMenu.classList.toggle('active');
    });
    document.addEventListener('click', () => {
      dropdownMenu.classList.remove('active');
    });
    dropdownMenu.addEventListener('click', (e) => {
      e.stopPropagation();
    });
    // Toggle navigation submenus
    const navToggles = document.querySelectorAll('.nav-toggle');
    navToggles.forEach(toggle => {
      toggle.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = toggle.getAttribute('data-target');
        const submenu = document.getElementById(targetId);
        const chevron = toggle.querySelector('.nav-chevron');
        navToggles.forEach(otherToggle => {
          if (otherToggle !== toggle) {
            const otherTargetId = otherToggle.getAttribute('data-target');
            const otherSubmenu = document.getElementById(otherTargetId);
            const otherChevron = otherToggle.querySelector('.nav-chevron');
            otherSubmenu.classList.remove('active');
            otherToggle.classList.remove('active');
            otherChevron.style.transform = 'rotate(0deg)';
          }
        });
        submenu.classList.toggle('active');
        toggle.classList.toggle('active');
        chevron.style.transform = submenu.classList.contains('active') ? 'rotate(90deg)' : 'rotate(0deg)';
      });
    });
    // --- Lógica específica para editar ventas ---
    // Elementos del modal
    const productModal = document.getElementById('productModal');
    const closeModalBtn = document.getElementById('closeModal');
    const openProductSearchBtn = document.getElementById('openProductSearchBtn');
    const productSearchInput = document.getElementById('productSearch');
    const productSearchResultsBody = document.getElementById('productSearchResultsBody');
    const emptySearchResultsDiv = document.getElementById('emptySearchResults');
    // Abrir modal
    openProductSearchBtn.addEventListener('click', () => {
      productModal.classList.add('active');
      overlay.classList.add('active');
      document.body.classList.add('modal-open');
      productSearchInput.value = '';
      renderProductSearchResults(allProducts);
      productSearchInput.focus();
    });
    // Cerrar modal
    closeModalBtn.addEventListener('click', () => {
      productModal.classList.remove('active');
      overlay.classList.remove('active');
      document.body.classList.remove('modal-open');
    });
    overlay.addEventListener('click', () => {
      if (productModal.classList.contains('active')) {
        productModal.classList.remove('active');
        overlay.classList.remove('active');
        document.body.classList.remove('modal-open');
      }
    });
    // Filtrar productos basado en búsqueda
    productSearchInput.addEventListener('input', () => {
      const searchTerm = productSearchInput.value.toLowerCase();
      const filtered = allProducts.filter(product =>
        product.nombreProducto.toLowerCase().includes(searchTerm) ||
        (product.talla && product.talla.toLowerCase().includes(searchTerm)) ||
        (product.color && product.color.toLowerCase().includes(searchTerm)) ||
        (product.descripcion && product.descripcion.toLowerCase().includes(searchTerm))
      );
      renderProductSearchResults(filtered);
    });
    // Mostrar resultados de búsqueda en el modal
    function renderProductSearchResults(products) {
      productSearchResultsBody.innerHTML = '';
      if (products.length === 0) {
        emptySearchResultsDiv.style.display = 'block';
      } else {
        emptySearchResultsDiv.style.display = 'none';
        products.forEach(product => {
          const isAdded = productosAgregados.some(p => p.productoId == product.idProducto);
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${product.nombreProducto} ${isAdded ? '(Ya agregado)' : ''}</td>
            <td>${product.talla || '-'}</td> <!-- CORRECCIÓN AQUÍ: Usar product.talla -->
            <td>${product.color || '-'}</td>
            <td>$${product.costo.toFixed(2)}</td>
            <td>${product.stock}</td>
            <td>
              <button type="button" class="btn btn-add-small"
                      onclick="selectProductFromModal(${product.idProducto})"
                      ${isAdded ? 'disabled' : ''}>
                <svg viewBox="0 0 24 24" width="16" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
              </button>
            </td>
          `;
          productSearchResultsBody.appendChild(row);
        });
      }
    }
    // Seleccionar producto del modal y agregar a la lista
    function selectProductFromModal(productId) {
      const productToAdd = allProducts.find(p => p.idProducto == productId);
      if (!productToAdd) {
        alert("Error: Producto no encontrado.");
        return;
      }
      agregarProducto(productToAdd);
      closeModalBtn.click();
    }
    // Agregar producto a la lista de venta
    function agregarProducto(product) {
      const productoId = product.idProducto;
      const productoExistente = productosAgregados.find(p => p.productoId == productoId);
      if (productoExistente) {
        if (productoExistente.cantidad >= product.stock) {
          alert("No hay suficiente stock disponible para este producto");
          return;
        }
        productoExistente.cantidad++;
      } else {
        productosAgregados.push({
          productoId: productoId,
          nombre: product.nombreProducto,
          precio: product.costo,
          cantidad: 1,
          stock: product.stock
        });
      }
      actualizarListaProductos();
      actualizarResumen();
    }
    // Actualizar la tabla de productos agregados
    function actualizarListaProductos() {
      const tbody = document.querySelector("#productosAgregados tbody");
      const container = document.getElementById("productosHiddenContainer");
      const emptyProductsDiv = document.getElementById("emptyProducts");
      tbody.innerHTML = "";
      container.innerHTML = "";
      if (productosAgregados.length === 0) {
        emptyProductsDiv.style.display = "block";
        return;
      }
      emptyProductsDiv.style.display = "none";
      productosAgregados.forEach((producto, index) => {
        // Crear fila en la tabla
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${producto.nombre}</td>
          <td>
            <div class="quantity-control">
              <button type="button" onclick="cambiarCantidad(${producto.productoId}, -1)">−</button>
              <span>${producto.cantidad}</span>
              <button type="button" onclick="cambiarCantidad(${producto.productoId}, 1)">+</button>
            </div>
          </td>
          <td>$${producto.precio.toFixed(2)}</td>
          <td>$${(producto.precio * producto.cantidad).toFixed(2)}</td>
          <td>
            <button type="button" onclick="eliminarProducto('${producto.productoId}')" class="remove-product">
              <svg viewBox="0 0 24 24" width="16" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </td>
        `;
        tbody.appendChild(row);
        // Crear inputs ocultos para el formulario
        const prefix = `items[${index}]`;
        const idInput = document.createElement("input");
        idInput.type = "hidden";
        idInput.name = `${prefix}.productoId`;
        idInput.value = producto.productoId;
        container.appendChild(idInput);
        const cantidadInput = document.createElement("input");
        cantidadInput.type = "hidden";
        cantidadInput.name = `${prefix}.cantidad`;
        cantidadInput.value = producto.cantidad;
        container.appendChild(cantidadInput);
        // Añadir input oculto para precioUnitario
        const precioUnitarioInput = document.createElement("input");
        precioUnitarioInput.type = "hidden";
        precioUnitarioInput.name = `${prefix}.precioUnitario`;
        precioUnitarioInput.value = producto.precio; // Usar el precio del producto agregado
        container.appendChild(precioUnitarioInput);
      });
    }
    // Cambiar cantidad de un producto
    function cambiarCantidad(productId, delta) {
      const producto = productosAgregados.find(p => p.productoId == productId);
      if (producto) {
        const nuevaCantidad = producto.cantidad + delta;
        if (nuevaCantidad < 1) {
          return;
        }
        const productInAllProducts = allProducts.find(p => p.idProducto == productId);
        if (nuevaCantidad > productInAllProducts.stock) { // Compara con el stock del producto general
          alert("No hay suficiente stock disponible");
          return;
        }
        producto.cantidad = nuevaCantidad;
        actualizarListaProductos();
        actualizarResumen();
      }
    }
    // Eliminar producto de la lista
    function eliminarProducto(productId) {
      productosAgregados = productosAgregados.filter(p => p.productoId != productId);
      actualizarListaProductos();
      actualizarResumen();
    }
    // Actualizar resumen de la venta
    function actualizarResumen() {
      const subtotal = productosAgregados.reduce((sum, p) => sum + (p.precio * p.cantidad), 0);
      const porcentajeInput = document.getElementById("porcentajeInput");
      const porcentaje = parseFloat(porcentajeInput.value) || 0;
      const montoPorcentaje = subtotal * porcentaje / 100;
      const total = subtotal + montoPorcentaje;
      document.getElementById("totalHidden").value = total.toFixed(2);
      document.getElementById("subtotalAmount").textContent = `$${subtotal.toFixed(2)}`;
      const percentageElement = document.getElementById("percentageAmount");
      if (porcentaje === 0) {
        percentageElement.textContent = "0% ($0.00)";
        percentageElement.className = "summary-value";
      } else {
        const sign = porcentaje >= 0 ? "+" : "";
        percentageElement.textContent = `${porcentaje}% (${sign}${(montoPorcentaje).toFixed(2)})`;
        percentageElement.className = `summary-value ${porcentaje >= 0 ? 'positive' : 'negative'}`;
      }
      document.getElementById("totalAmount").textContent = `$${total.toFixed(2)}`;
    }
    // Inicialización al cargar la página
    document.addEventListener("DOMContentLoaded", () => {
      // Configurar porcentaje inicial (asumo que viene de ventaEditar.porcentaje)
      const porcentajeInput = document.getElementById("porcentajeInput");
      const initialPercentage = /*[[${ventaEditar.porcentaje ?: 0}]]*/ 0; // Obtener porcentaje del backend
      porcentajeInput.value = initialPercentage;

      // Configurar eventos
      porcentajeInput.addEventListener("input", actualizarResumen);
      document.querySelectorAll("input[name='tipoDeVenta']").forEach(radio => {
        radio.addEventListener("change", actualizarResumen);
      });
      document.querySelectorAll("input[name='modalidadVenta']").forEach(radio => {
        radio.addEventListener("change", actualizarResumen);
      });
      // Mostrar productos existentes y calcular resumen
      actualizarListaProductos();
      actualizarResumen();
      // Validación del formulario
      document.getElementById("salesForm").addEventListener("submit", (e) => {
        if (productosAgregados.length === 0) {
          e.preventDefault();
          alert("Debe agregar al menos un producto a la venta.");
          openProductSearchBtn.focus();
          return;
        }
        const nombreCliente = document.getElementById("nombreCliente").value.trim();
        if (!nombreCliente) {
          e.preventDefault();
          alert("El nombre del cliente es obligatorio.");
          document.getElementById("nombreCliente").focus();
          return;
        }
        const tipoVenta = document.querySelector("input[name='tipoDeVenta']:checked");
        if (!tipoVenta) {
          e.preventDefault();
          alert("Por favor seleccione un método de pago.");
          return;
        }
        const modalidadVenta = document.querySelector("input[name='modalidadVenta']:checked");
        if (!modalidadVenta) {
          e.preventDefault();
          alert("Por favor seleccione una modalidad de venta.");
          return;
        }
      });
    });
</script>
</body>
</html>
