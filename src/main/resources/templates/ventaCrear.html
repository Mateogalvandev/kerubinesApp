<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kerubines App - Crear Venta</title>
    <link rel="stylesheet" th:href="@{/css/productoStyle.css}"> <!-- Estilos base del sistema -->
    <link rel="stylesheet" th:href="@{/css/productoTabla.css}"> <!-- Estilos específicos de la tabla -->
    <link rel="stylesheet" th:href="@{/css/ventaStyle.css}"> <!-- Estilos específicos para ventas -->
</head>
<body>
<!-- Header -->
<header class="header">
    <div class="header-left">
        <button class="menu-toggle" id="menuToggle">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <h1 class="logo"><a href="/">Kerubines App</a></h1>
    </div>
    <div class="header-right">
        <div class="user-menu">
            <button class="user-button" id="userButton">
                <svg class="user-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
                <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6,9 12,15 18,9"></polyline>
                </svg>
            </button>
            <div class="dropdown-menu" id="dropdownMenu">
                <form action="/logout" method="post" style="margin: 0; padding: 0;">
                    <button type="submit" class="dropdown-item logout">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16,17 21,12 16,7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        Cerrar Sesión
                    </button>
                </form>
            </div>
        </div>
    </div>
</header>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
    <nav class="sidebar-nav">
        <!-- Venta Section -->
        <div class="nav-section">
            <button class="nav-item nav-toggle" data-target="ventaSubmenu">
                <div class="nav-item-content">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3h18v18H3zM9 9h6v6H9z"></path>
                    </svg>
                    <span>Venta</span>
                </div>
                <svg class="nav-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9,18 15,12 9,6"></polyline>
                </svg>
            </button>
            <div class="nav-submenu" id="ventaSubmenu">
                <a href="#" class="nav-subitem active" th:href="@{/venta/crear}">
                    <svg class="nav-subicon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Crear
                </a>
                <a href="#" class="nav-subitem" th:href="@{/venta/administrar}">
                    <svg class="nav-subicon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                    </svg>
                    Administrar
                </a>
            </div>
        </div>
        <!-- Usuarios Section -->
        <div class="nav-section">
            <button class="nav-item nav-toggle" data-target="usuariosSubmenu">
                <div class="nav-item-content">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span>Usuarios</span>
                </div>
                <svg class="nav-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9,18 15,12 9,6"></polyline>
                </svg>
            </button>
            <div class="nav-submenu" id="usuariosSubmenu">
                <a href="#" class="nav-subitem" th:href="@{/register}">
                    <svg class="nav-subicon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Crear
                </a>
                <a href="#" class="nav-subitem" th:href="@{/usuarios/administrar}">
                    <svg class="nav-subicon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                    </svg>
                    Administrar
                </a>
            </div>
        </div>
        <!-- Productos Section -->
        <div class="nav-section">
            <button class="nav-item nav-toggle" data-target="productosSubmenu">
                <div class="nav-item-content">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <path d="M16 10a4 4 0 0 1-8 0"></path>
                    </svg>
                    <span>Productos</span>
                </div>
                <svg class="nav-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9,18 15,12 9,6"></polyline>
                </svg>
            </button>
            <div class="nav-submenu" id="productosSubmenu">
                <a href="#" class="nav-subitem" th:href="@{/productos/crear}">
                    <svg class="nav-subicon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Crear
                </a>
                <a href="#" class="nav-subitem" th:href="@{/productos/administrar}">
                    <svg class="nav-subicon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                    </svg>
                    Administrar
                </a>
            </div>
        </div>
    </nav>
</aside>

<!-- Main Content -->
<main class="main-content" id="mainContent">
    <div class="content-wrapper">
        <div class="page-header">
            <h2 class="page-title">Crear Nueva Venta</h2>
            <p class="page-description">Completa la información de la venta para registrarla en el sistema</p>
        </div>
        <div class="form-container">
            <form id="ventaForm" th:action="@{/venta/crear/post}" th:object="${ventaEntidad}" method="post">
                <div class="form-grid">
                    <!-- ID Venta (Auto-generado) -->
                    <div class="form-group">
                        <label for="idVenta" class="form-label">ID Venta</label>
                        <input
                                type="text"
                                id="idVenta"
                                th:field="*{idVenta}"
                                class="form-input"
                                placeholder="Se generará automáticamente"
                                readonly
                        >
                    </div>

                    <!-- Fecha y Tipo de Venta en la misma fila -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date" class="form-label required">Fecha</label>
                            <input
                                    type="datetime-local"
                                    id="date"
                                    th:field="*{date}"
                                    class="form-input"
                                    required
                            >
                        </div>
                        <div class="form-group">
                            <label for="tipoDeVenta" class="form-label required">Tipo de Venta</label>
                            <select
                                    id="tipoDeVenta"
                                    th:field="*{tipoDeVenta}"
                                    class="form-input"
                                    required
                            >
                                <option value="">Seleccionar tipo</option>
                                <option value="EFECTIVO">Efectivo</option>
                                <option value="TARJETA_CREDITO">Tarjeta de Crédito</option>
                                <option value="TARJETA_DEBITO">Tarjeta de Débito</option>
                                <option value="TRANSFERENCIA">Transferencia Bancaria</option>
                                <option value="CHEQUE">Cheque</option>
                                <option value="CREDITO">Crédito</option>
                            </select>
                        </div>
                    </div>

                    <!-- Total y Usuario en la misma fila -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="total" class="form-label required">Total</label>
                            <div class="input-with-icon">
                                <span class="input-icon">$</span>
                                <input
                                        type="number"
                                        id="total"
                                        th:field="*{total}"
                                        class="form-input"
                                        placeholder="0.00"
                                        step="0.01"
                                        min="0"
                                        required
                                        readonly
                                >
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="usuarioVentaIdUsuario" class="form-label required">Usuario Responsable</label>
                            <select
                                    id="usuarioVentaIdUsuario"
                                    th:field="*{usuarioVentaIdUsuario}"
                                    class="form-input"
                                    required
                            >
                                <option value="">Seleccionar usuario</option>
                                <option th:each="user : ${userList}"
                                        th:value="${user.id}"
                                        th:text="${user.nombre + ' ' + user.apellido}">
                                </option>
                            </select>
                        </div>
                    </div>

                    <!-- Productos Section -->
                    <div class="form-group">
                        <label class="form-label">Productos</label>
                        <div class="products-container">
                            <div class="products-header">
                                <div class="product-grid-header">
                                    <span>Producto</span>
                                    <span>Cantidad</span>
                                    <span>Precio Unit.</span>
                                    <span>Subtotal</span>
                                    <span>Acción</span>
                                </div>
                            </div>
                            <div id="productContainer">
                                <div class="product-row">
                                    <select class="form-input product-select" name="products[0].id">
                                        <option value="">Seleccionar producto</option>
                                        <option th:each="product : ${productList}"
                                                th:value="${product.id}"
                                                th:text="${product.nombreProducto}"
                                                th:data-price="${product.costo}">
                                        </option>
                                    </select>
                                    <input type="number" class="form-input quantity-input"
                                           name="products[0].quantity" placeholder="1"
                                           min="1" value="1">
                                    <input type="text" class="form-input price-display"
                                           placeholder="$0.00" readonly>
                                    <input type="text" class="form-input subtotal-input"
                                           placeholder="$0.00" readonly>
                                    <button type="button" class="btn-icon btn-danger remove-product">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3,6 5,6 21,6"></polyline>
                                            <path d="M19,6v14a2,2 0 0,1-2,2H7a2,2 0 0,1-2-2V6m3,0V4a2,2 0 0,1,2-2h4a2,2 0 0,1,2,2v2"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <button type="button" class="btn btn-secondary" id="addProduct">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                Agregar Producto
                            </button>
                        </div>
                    </div>

                    <!-- Resumen de la venta -->
                    <div class="form-group">
                        <div class="sale-summary">
                            <div class="summary-row">
                                <span>Subtotal:</span>
                                <span id="summarySubtotal">$0.00</span>
                            </div>
                            <div class="summary-row">
                                <span>IVA (16%):</span>
                                <span id="summaryTax">$0.00</span>
                            </div>
                            <div class="summary-row total-row">
                                <span>Total:</span>
                                <span id="summaryTotal">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelButton">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 6L6 18M6 6l12 12"></path>
                        </svg>
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                            <polyline points="17,21 17,13 7,13 7,21"></polyline>
                            <polyline points="7,3 7,8 15,8"></polyline>
                        </svg>
                        Guardar Venta
                    </button>
                </div>
            </form>
        </div>
    </div>
</main>

<!-- Overlay for mobile -->
<div class="overlay" id="overlay"></div>

<script>
    // Toggle sidebar
    const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const overlay = document.getElementById('overlay');

    menuToggle.addEventListener('click', () => {
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
        document.body.classList.toggle('sidebar-open');
    });

    overlay.addEventListener('click', () => {
        sidebar.classList.remove('active');
        overlay.classList.remove('active');
        document.body.classList.remove('sidebar-open');
    });

    // Toggle user dropdown
    const userButton = document.getElementById('userButton');
    const dropdownMenu = document.getElementById('dropdownMenu');

    userButton.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdownMenu.classList.toggle('active');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', () => {
        dropdownMenu.classList.remove('active');
    });

    dropdownMenu.addEventListener('click', (e) => {
        e.stopPropagation();
    });

    // Toggle navigation submenus
    const navToggles = document.querySelectorAll('.nav-toggle');
    navToggles.forEach(toggle => {
        toggle.addEventListener('click', (e) => {
            e.preventDefault();
            const targetId = toggle.getAttribute('data-target');
            const submenu = document.getElementById(targetId);
            const chevron = toggle.querySelector('.nav-chevron');

            // Close other submenus
            navToggles.forEach(otherToggle => {
                if (otherToggle !== toggle) {
                    const otherTargetId = otherToggle.getAttribute('data-target');
                    const otherSubmenu = document.getElementById(otherTargetId);
                    const otherChevron = otherToggle.querySelector('.nav-chevron');
                    otherSubmenu.classList.remove('active');
                    otherToggle.classList.remove('active');
                    otherChevron.style.transform = 'rotate(0deg)';
                }
            });

            // Toggle current submenu
            submenu.classList.toggle('active');
            toggle.classList.toggle('active');
            if (submenu.classList.contains('active')) {
                chevron.style.transform = 'rotate(90deg)';
            } else {
                chevron.style.transform = 'rotate(0deg)';
            }
        });
    });

    // Handle submenu item clicks
    const subItems = document.querySelectorAll('.nav-subitem');
    subItems.forEach(item => {
        item.addEventListener('click', () => {
            // Remove active class from all subitems
            subItems.forEach(subItem => subItem.classList.remove('active'));
            // Add active class to clicked item
            item.classList.add('active');
        });
    });

    // Sales form functionality
    let productIndex = 1;

    // Set current date and time
    document.addEventListener('DOMContentLoaded', () => {
        const now = new Date();
        const formattedDate = now.toISOString().slice(0, 16);
        document.getElementById('date').value = formattedDate;

        // Initialize the sales submenu as active on page load
        const ventaToggle = document.querySelector('[data-target="ventaSubmenu"]');
        const ventaSubmenu = document.getElementById('ventaSubmenu');
        const ventaChevron = ventaToggle.querySelector('.nav-chevron');

        // Force open the Venta submenu
        ventaSubmenu.classList.add('active');
        ventaToggle.classList.add('active');
        ventaChevron.style.transform = 'rotate(90deg)';

        // Mark "Crear" item as active in submenu
        const createItem = document.querySelector('a[th\\:href*="/venta/crear"]');
        if (createItem) {
            createItem.classList.add('active');
        }
    });

    // Add product functionality
    document.getElementById('addProduct').addEventListener('click', function() {
        const newRow = document.createElement('div');
        newRow.className = 'product-row';
        newRow.innerHTML = `
            <select class="form-input product-select" name="products[${productIndex}].id">
                <option value="">Seleccionar producto</option>
                <option th:each="product : \${productList}"
                        th:value="\${product.id}"
                        th:text="\${product.nombreProducto}"
                        th:data-price="\${product.costo}">
                </option>
            </select>
            <input type="number" class="form-input quantity-input"
                   name="products[${productIndex}].quantity" placeholder="1"
                   min="1" value="1">
            <input type="text" class="form-input price-display"
                   placeholder="$0.00" readonly>
            <input type="text" class="form-input subtotal-input"
                   placeholder="$0.00" readonly>
            <button type="button" class="btn-icon btn-danger remove-product">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3,6 5,6 21,6"></polyline>
                    <path d="M19,6v14a2,2 0 0,1-2,2H7a2,2 0 0,1-2-2V6m3,0V4a2,2 0 0,1,2-2h4a2,2 0 0,1,2,2v2"></path>
                </svg>
            </button>
        `;
        document.getElementById('productContainer').appendChild(newRow);
        productIndex++;
    });

    // Remove product functionality
    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-product')) {
            const productRows = document.querySelectorAll('.product-row');
            if (productRows.length > 1) {
                e.target.closest('.product-row').remove();
                calculateTotal();
            }
        }
    });

    // Calculate subtotal when product or quantity changes
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('product-select') || e.target.classList.contains('quantity-input')) {
            const row = e.target.closest('.product-row');
            const productSelect = row.querySelector('.product-select');
            const quantityInput = row.querySelector('.quantity-input');
            const priceDisplay = row.querySelector('.price-display');
            const subtotalInput = row.querySelector('.subtotal-input');

            const selectedOption = productSelect.options[productSelect.selectedIndex];
            const price = parseFloat(selectedOption.dataset.price) || 0;
            const quantity = parseInt(quantityInput.value) || 0;
            const subtotal = price * quantity;

            priceDisplay.value = `$${price.toFixed(2)}`;
            subtotalInput.value = `$${subtotal.toFixed(2)}`;
            calculateTotal();
        }
    });

    // Calculate total
    function calculateTotal() {
        let subtotal = 0;
        document.querySelectorAll('.subtotal-input').forEach(input => {
            const value = parseFloat(input.value.replace('$', '')) || 0;
            subtotal += value;
        });

        const tax = subtotal * 0.16; // 16% IVA
        const total = subtotal + tax;

        document.getElementById('summarySubtotal').textContent = `$${subtotal.toFixed(2)}`;
        document.getElementById('summaryTax').textContent = `$${tax.toFixed(2)}`;
        document.getElementById('summaryTotal').textContent = `$${total.toFixed(2)}`;
        document.getElementById('total').value = total.toFixed(2);

        // Add visual feedback
        const summary = document.querySelector('.sale-summary');
        summary.classList.add('updated');
        setTimeout(() => summary.classList.remove('updated'), 1000);
    }

    // Form validation
    document.getElementById('ventaForm').addEventListener('submit', function(e) {
        let hasProducts = false;
        document.querySelectorAll('.product-select').forEach(select => {
            if (select.value) {
                hasProducts = true;
            }
        });

        if (!hasProducts) {
            e.preventDefault();
            alert('Debe seleccionar al menos un producto para la venta.');
            return false;
        }
    });

    // Cancel button functionality
    document.getElementById('cancelButton').addEventListener('click', () => {
        if (confirm('¿Estás seguro de que quieres cancelar? Se perderán los datos ingresados.')) {
            document.getElementById('ventaForm').reset();
            // Reset date to current
            const now = new Date();
            const formattedDate = now.toISOString().slice(0, 16);
            document.getElementById('date').value = formattedDate;
            // Reset summary
            document.getElementById('summarySubtotal').textContent = '$0.00';
            document.getElementById('summaryTax').textContent = '$0.00';
            document.getElementById('summaryTotal').textContent = '$0.00';
        }
    });
</script>
</body>
</html>